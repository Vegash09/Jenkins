pipeline {
    agent any
    
    environment {
        DATABRICKS_CLIENT_ID = 'e1720236-6ef3-47c5-b73e-700d4a171681'
        DATABRICKS_CLIENT_SECRET = 'dosed0e6ab7e4b30bb5ba34f5b3971c88456'
        DATABRICKS_HOST = 'https://adb-7405617499680447.7.azuredatabricks.net/'
        DATABRICKS_BUNDLE_ENV = 'production'
        BUNDLE_VAR_DATABRICKS_CLIENT_ID = 'e1720236-6ef3-47c5-b73e-700d4a171681'
    }
    
    options {
        skipDefaultCheckout(false)
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code from GitHub repository...'
                checkout scm
            }
        }
        
        stage('Setup Databricks CLI') {
            steps {
                script {
                    echo 'Downloading and installing Databricks CLI...'
                    powershell '''
                        $ErrorActionPreference = "Stop"
                        
                        $cliPath = "C:\\databricks-cli"
                        $cliExe = "$cliPath\\databricks.exe"
                        
                        # Create directory
                        if (!(Test-Path $cliPath)) {
                            New-Item -ItemType Directory -Path $cliPath -Force | Out-Null
                            Write-Host "Created directory: $cliPath"
                        }
                        
                        # Check if already installed
                        if (Test-Path $cliExe) {
                            Write-Host "Databricks CLI already exists!"
                            & $cliExe version
                            exit 0
                        }
                        
                        Write-Host "Downloading Databricks CLI..."
                        
                        # Use the correct URL format
                        $version = "v0.234.0"  # Using a stable version
                        $downloadUrl = "https://github.com/databricks/cli/releases/download/$version/databricks_cli_${version}_windows_amd64.zip"
                        $zipFile = "$env:TEMP\\databricks_cli.zip"
                        
                        Write-Host "Download URL: $downloadUrl"
                        
                        try {
                            # Download with progress
                            $ProgressPreference = 'SilentlyContinue'
                            Invoke-WebRequest -Uri $downloadUrl -OutFile $zipFile -UseBasicParsing
                            Write-Host "Downloaded successfully!"
                            
                            # Extract
                            Write-Host "Extracting..."
                            Expand-Archive -Path $zipFile -DestinationPath $cliPath -Force
                            
                            # Verify extraction
                            if (Test-Path $cliExe) {
                                Write-Host "Installation successful!"
                                & $cliExe version
                            } else {
                                Write-Host "ERROR: databricks.exe not found after extraction!"
                                Write-Host "Contents of $cliPath :"
                                Get-ChildItem $cliPath | Format-Table Name
                                exit 1
                            }
                            
                            # Cleanup
                            Remove-Item $zipFile -Force -ErrorAction SilentlyContinue
                            
                        } catch {
                            Write-Host "ERROR: $_"
                            Write-Host "Failed URL: $downloadUrl"
                            
                            # Try alternate method - download latest directly
                            Write-Host "`nTrying alternate download method..."
                            
                            try {
                                # Download databricks.exe directly without version
                                $altUrl = "https://github.com/databricks/cli/releases/download/v0.234.0/databricks_cli_0.234.0_windows_amd64.zip"
                                Invoke-WebRequest -Uri $altUrl -OutFile $zipFile -UseBasicParsing
                                Expand-Archive -Path $zipFile -DestinationPath $cliPath -Force
                                
                                if (Test-Path $cliExe) {
                                    Write-Host "Alternate download successful!"
                                    & $cliExe version
                                } else {
                                    throw "Still could not find databricks.exe"
                                }
                            } catch {
                                Write-Host "ERROR: Alternate method also failed: $_"
                                exit 1
                            }
                        }
                    '''
                }
            }
        }
        
        stage('Ensure Python files are Databricks notebooks') {
            steps {
                script {
                    echo 'Prepending Databricks notebook header to all .py files...'
                    powershell '''
                        $header = "# Databricks notebook source"
                        $processedCount = 0
                        $skippedCount = 0
                        
                        Write-Host "Scanning for Python files in: $env:WORKSPACE"
                        
                        Get-ChildItem -Path $env:WORKSPACE -Filter "*.py" -Recurse | ForEach-Object {
                            $file = $_.FullName
                            Write-Host "Found: $($_.Name)"
                            
                            try {
                                $content = Get-Content $file -Raw -ErrorAction Stop
                                
                                if ($content -and $content -notmatch "^# Databricks notebook source") {
                                    $newContent = "$header`n$content"
                                    Set-Content -Path $file -Value $newContent -NoNewline
                                    Write-Host "  Added header" -ForegroundColor Green
                                    $processedCount++
                                } else {
                                    Write-Host "  Already has header" -ForegroundColor Yellow
                                    $skippedCount++
                                }
                            } catch {
                                Write-Host "  Error: $_" -ForegroundColor Red
                            }
                        }
                        
                        Write-Host "`nProcessed: $processedCount | Skipped: $skippedCount"
                    '''
                }
            }
        }
        
        stage('Validate Databricks Bundle') {
            steps {
                script {
                    echo 'Validating Databricks asset bundle...'
                    bat '''
                        set PATH=%PATH%;C:\\databricks-cli
                        
                        echo.
                        echo ========================================
                        echo Running: databricks bundle validate
                        echo ========================================
                        echo.
                        
                        databricks bundle validate
                        
                        echo.
                        echo Validation completed successfully!
                    '''
                }
            }
        }
        
        stage('Deploy Databricks Bundle') {
            when {
                expression { 
                    currentBuild.result == null || currentBuild.result == 'SUCCESS' 
                }
            }
            steps {
                script {
                    echo 'Deploying Databricks asset bundle...'
                    bat '''
                        set PATH=%PATH%;C:\\databricks-cli
                        
                        echo.
                        echo ========================================
                        echo Running: databricks bundle deploy
                        echo ========================================
                        echo.
                        
                        databricks bundle deploy
                        
                        echo.
                        echo Deployment completed successfully!
                    '''
                }
            }
        }
    }
    
    post {
        failure {
            echo '=========================================='
            echo 'Pipeline FAILED!'
            echo '=========================================='
        }
        success {
            echo '=========================================='
            echo 'Pipeline completed SUCCESSFULLY!'
            echo '=========================================='
        }
        always {
            echo 'Cleaning up workspace...'
            cleanWs()
        }
    }
}